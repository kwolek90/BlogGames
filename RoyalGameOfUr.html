<!DOCTYPE html>
<html>
<head>
    <!--<script src="http://labs.phaser.io/build/phaser-arcade-physics.min.js"></script>-->
    <!--<script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/4.7.1/pixi.min.js"></script>-->
    <script src="node_modules/pixi.js/dist/pixi.js"></script>
</head>
<body>

<script src="Player.js"></script>
<script src="Pawn.js"></script>
<script src="Tiles.js"></script>
<script>


    var whiteLine = 25;
    var blackLine = 325;
    var tiles = [];
    var board = [];
    var tile_size = 65;
    var pawnNumber = 7;
    var finished = false;
    var currentPlayer;
    var players = [];
    var endTile = "end";
    var dicesTile;

    var filter = new PIXI.filters.ColorMatrixFilter();

    function sign(valueToGetSign) {
        return typeof valueToGetSign === 'number' ? valueToGetSign ? valueToGetSign < 0 ? -1 : 1 : valueToGetSign === valueToGetSign ? 0 : NaN : NaN;
    }

    class Move {
        constructor(i, j) {
            this.i = i;
            this.j = j;
        }
    }

    function nextPlayerTurn() {
        var ind = players.indexOf(currentPlayer);
        var nind = (ind + 1) % players.length;
        setCurrentPlayer(nind);
    }

    function setCurrentPlayer(playerID) {
        currentPlayer = players[playerID];
        currentPlayer.startTurn();
        //for (var id in img_token) {
        //    img_token[id].style.border = "none";
        //}

        //if (playerID in img_token)
        //    img_token[playerID].style.border = "thick solid #0000FF";
    }



    let app = new PIXI.Application({
            width: 800,
            height: 426,
            antialiasing: true,
            transparent: true,
            resolution: 1
        }
    );
    //Add the canvas that Pixi automatically created for you to the HTML document
    document.body.appendChild(app.view);
    //load an image and run the `setup` function when it's done
    PIXI.loader
        .add("dices.png")
        .add("board.png")
        .add("white.png")
        .add("black.png")
        .load(setup);
    //This `setup` function will run when the image has loaded
    function setup() {
        //Create the cat sprite
        //let dices = new PIXI.Sprite(PIXI.loader.resources["dices.png"].texture);
        let boardSprite = new PIXI.Sprite(PIXI.loader.resources["board.png"].texture);
        boardSprite.position.x = 0;
        boardSprite.position.y = 70;
        var white = PIXI.Texture.fromImage("white.png");
        var black = PIXI.Texture.fromImage("black.png");



        app.stage.addChild(boardSprite);
        // board.interactive = true;
        // board.on('pointerdown', onClick);
        var rollText = new PIXI.Text('ROLL');
        rollText.x = 700;
        rollText.y = 200;
        dicesTile = new RollTile(675, 150, 120, 50);
        rollText.interactive = true;
        rollText.on('pointerdown',function(){dicesTile.onClick();});
        app.stage.addChild(rollText);

        board = [];
        tiles = [];

        board[0] = new RouteTile(0, 254, 75, tile_size, tile_size);
        board[1] = new RouteTile(1, 180, 75, tile_size, tile_size);
        board[2] = new RouteTile(2, 103, 75, tile_size, tile_size);
        board[3] = new RouteTile(3, 23, 75, tile_size, tile_size);
        board[4] = new RouteTile(0, 254, 229, tile_size, tile_size);
        board[5] = new RouteTile(1, 180, 229, tile_size, tile_size);
        board[6] = new RouteTile(2, 103, 229, tile_size, tile_size);
        board[7] = new RouteTile(3, 23, 229, tile_size, tile_size);
        board[8] = new RouteTile(4, 23, 153, tile_size, tile_size);
        board[9] = new RouteTile(5, 103, 153, tile_size, tile_size);
        board[10] = new RouteTile(6, 180, 153, tile_size, tile_size);
        board[11] = new RouteTile(7, 254, 153, tile_size, tile_size);
        board[12] = new RouteTile(8, 330, 153, tile_size, tile_size);
        board[13] = new RouteTile(9, 405, 153, tile_size, tile_size);
        board[14] = new RouteTile(10, 485, 153, tile_size, tile_size);
        board[15] = new RouteTile(11, 560, 153, tile_size, tile_size);
        board[16] = new RouteTile(12, 560, 75, tile_size, tile_size);
        board[17] = new RouteTile(13, 485, 75, tile_size, tile_size);
        board[18] = new RouteTile(12, 560, 229, tile_size, tile_size);
        board[19] = new RouteTile(13, 485, 229, tile_size, tile_size);

        board[3].isRosette = true;
        board[7].isRosette = true;
        board[11].isRosette = true;
        board[17].isRosette = true;
        board[19].isRosette = true;

        for (let tile of board) {
            tiles.push(tile);
        }


        players[0] = new Player(0, 'white');
        players[0].BeginTile = new BeginTile(0, 0, 400, 60);
        players[0].EndTile = new EndTile(400, 0, 400, 60, players[0]);
        players[0].Route = [0, 1, 2, 3, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, endTile];
        tiles.push(players[0].BeginTile);
        tiles.push(players[0].EndTile);
        for (let i = 0; i < pawnNumber; i++) {
            let sprite = new PIXI.Sprite(white);
            sprite.x = 22 + i * 44;
            sprite.y = whiteLine;
            app.stage.addChild(sprite);
            let pawn = new Pawn(players[0], sprite);
            pawn.tile = players[0].BeginTile;
            players[0].pawns.push(pawn);
            players[0].BeginTile.pawns.push(pawn);
        }

        players[1] = new ComputerPlayer(1, 'black');
        players[1].BeginTile = new BeginTile(0, 310, 400, 60);
        players[1].EndTile = new EndTile(400, 310, 400, 60, players[1]);
        players[1].Route = [4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 18, 19, endTile];
        tiles.push(players[1].BeginTile);
        tiles.push(players[1].EndTile);
        for (let i = 0; i < pawnNumber; i++) {
            let sprite = new PIXI.Sprite(black);
            sprite.x = 22 + i * 44;
            sprite.y = blackLine;
            app.stage.addChild(sprite);
            let pawn = new Pawn(players[1], sprite);
            pawn.tile = players[1].BeginTile;
            players[1].pawns.push(pawn);
            players[1].BeginTile.pawns.push(pawn);
        }
        for (let tile of tiles) {
            if (board.indexOf(tile) === -1){
                tile.draw();
            }
            else{
                tile.draw();
            }
        }

        currentPlayer = players[0];

    }

</script>

</body>
</html>