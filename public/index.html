<!DOCTYPE html>
<html lang="pl">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/4.8.2/pixi.js"></script>
    <script
            src="https://code.jquery.com/jquery-3.3.1.min.js"
            integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
            crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
</head>
<body>

<div id="ChooseDiv">
    <div id="GameModeDiv">
        <label for="PvP">Gracz vs Gracz</label><input id="PvP" type="radio" name="gameMode" value="PvP" onchange="$('#PlayerColorDiv').hide();" checked>
        <label for="PvC">Gracz vs Komputer</label><input id="PvC" type="radio" name="gameMode" value="PvC" onchange="$('#PlayerColorDiv').show();">
        <label for="CvC">Komputer vs Komputer</label><input id="CvC" type="radio" name="gameMode" value="CvC" onchange="$('#PlayerColorDiv').hide();">
    </div>

    <div id="PlayerColorDiv" style="display: none">
        <label for="white">Białe</label><input id="white" type="radio" name="humanColor" value="white" checked>
        <label for="black">Czarne</label><input id="black" type="radio" name="humanColor" value="black">
    </div>

    <!--<label for="player1">Biały gracz: </label>-->
    <!--<select id="player1" title="Biały gracz">-->
        <!--<option value="computer">Computer</option>-->
        <!--<option value="human">Human</option>-->
    <!--</select>-->
    <!--<label for="player2">Drugi gracz: </label>-->
    <!--<select id="player2" title="Czarny gracz">-->
        <!--<option value="computer">Computer</option>-->
        <!--<option value="human">Human</option>-->
    <!--</select>-->

    <label for="PawnsNumber">Pawns number:</label>
    <select id="PawnsNumber"></select>

    <button onclick="StartGame()">Start</button>

</div>
<div id="SettingsDiv" style="display: none">
    <div id="AutoRollPlayer1Div" style="display: none">
        <label for="AutoRollPlayer1">Autoroll dla gracza białego</label>
        <input type="checkbox" id="AutoRollPlayer1" onchange="onAutoRollChange(this,0)">
    </div>
    <div id="AutoRollPlayer2Div" style="display: none">
        <label for="AutoRollPlayer2">Autoroll dla gracza czarnego</label>
        <input type="checkbox" id="AutoRollPlayer2" onchange="onAutoRollChange(this,1)">
    </div>
</div>

<button id="RestartButton" type="button" onclick="window.location.reload()" style="display: none">Restart</button>

<div id="DebugDiv" style="display: none">

    <div id="WhitePawnPosition"></div>
    <div id="BlackPawnPosition"></div>

    <div id="RollResult"></div>

    <div id="PawnPositionDiv">
        <div id="Player1PawnsDiv"></div>
        <div id="Player2PawnsDiv"></div>
    </div>
</div>

<script src="Player.js"></script>
<script src="Pawn.js"></script>
<script src="Tiles.js"></script>
<script>

    $(document).ready(function () {

        for(let i = 1; i<=100; i += 1){
            $('#PawnsNumber').append("<option value=\""+i+"\">"+i+"</option>");
        }

        let rollResult = $('#RollResult');
        rollResult.append("<input type='radio' name='diceResult' value='Roll' checked>Roll</input>");
        for(let i = 1; i<=4; i += 1){
            rollResult.append("<input type='radio' name='diceResult' value='"+i+"'>"+i+"</input>");
        }


    })

    function getRandomInt(min, max) {
        min = Math.ceil(min);
        max = Math.floor(max);
        return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    var AnimationQueue = {
        queue:[],
        isBusy: false,
        next:function(){
            let delay = 100;
            if(AnimationQueue.queue.length > 0){
                let operation_and_delay = AnimationQueue.queue.shift();
                let operation = operation_and_delay[0];
                delay = operation_and_delay[1];
                if(typeof operation === "function"){
                    operation();
                }
            }
            else{
                AnimationQueue.isBusy = false;
            }
            setTimeout(AnimationQueue.next, delay);

        },
        append:function(ms,callback){
            AnimationQueue.isBusy = true;
            AnimationQueue.queue.push([callback,ms]);
        }
    };

    class Game{

    }

    class Board{

    }

    var whiteLine = 25;
    var blackLine = 325;
    var tiles = [];
    var board = [];
    var tile_size = 65;
    var pawnNumber = 7;
    var finished = false;
    var currentPlayer;
    var players = [];
    var endTile = "end";
    var dicesTile;
    var rollText = new PIXI.Text('ROLL');





    function sign(valueToGetSign) {
        return typeof valueToGetSign === 'number' ? valueToGetSign ? valueToGetSign < 0 ? -1 : 1 : valueToGetSign === valueToGetSign ? 0 : NaN : NaN;
    }


    class Move {
        constructor(pawn, result) {
            this.pawn = pawn;
            this.result = result;
        }
    }

    function nextPlayerTurn() {
        if(finished === false){
            var ind = players.indexOf(currentPlayer);
            var nind = (ind + 1) % players.length;
            setCurrentPlayer(nind);
        }

        // players[0].writePawnsPosition("Player1PawnsDiv");
        // players[1].writePawnsPosition("Player2PawnsDiv");
    }

    function setCurrentPlayer(playerID) {
        currentPlayer = players[playerID];
        currentPlayer.startTurn();
    }

    function onAutoRollChange(e,id){
        players[id].autoroll = e.checked;
    }


    let app = new PIXI.Application({
            width: 1200,
            height: 800,
            antialiasing: true,
            transparent: true,
            resolution: 1
        }
    );
    //Add the canvas that Pixi automatically created for you to the HTML document
    document.body.appendChild(app.view);


    function StartGame(){
        //load an image and run the `setup` function when it's done
        //This `setup` function will run when the image has loaded


        AnimationQueue.next();
        $('#ChooseDiv').hide();
        $('#DebugDiv').show();
        $('#SettingsDiv').show();
        $('#RestartButton').show();

        pawnNumber = $('#PawnsNumber').val();

        PIXI.loader
            .add("dices.png")
            .add("board.png")
            .add("white.png")
            .add("black.png")
            .load(setup);
    }

    function createRouteTile(boardSprite,board,i,x,y,tile_size){
        board[i] = new RouteTile(boardSprite.position.x + x, boardSprite.position.y + y, tile_size, tile_size);
    }

    function setup() {

        let boardSprite = new PIXI.Sprite(PIXI.loader.resources["board.png"].texture);
        boardSprite.position.x = 0;
        boardSprite.position.y = 100;
        let white = PIXI.Texture.fromImage("white.png");
        let black = PIXI.Texture.fromImage("black.png");



        app.stage.addChild(boardSprite);
        rollText.x = 700;
        rollText.y = 200;
        dicesTile = new RollTile(675, 150, 120, 50);
        rollText.interactive = true;
        rollText.on('pointerdown',function(){dicesTile.onClick();});
        app.stage.addChild(rollText);

        board = [];
        tiles = [];


        createRouteTile(boardSprite,board,0, 254, 5, tile_size);
        createRouteTile(boardSprite,board,1, 180, 5, tile_size);
        createRouteTile(boardSprite,board,2, 103, 5, tile_size);
        createRouteTile(boardSprite,board,3, 23, 5, tile_size);
        createRouteTile(boardSprite,board,4, 254, 159, tile_size);
        createRouteTile(boardSprite,board,5, 180, 159, tile_size);
        createRouteTile(boardSprite,board,6, 103, 159, tile_size);
        createRouteTile(boardSprite,board,7, 23, 159, tile_size);
        createRouteTile(boardSprite,board,8, 23, 83, tile_size);
        createRouteTile(boardSprite,board,9, 103, 83, tile_size);
        createRouteTile(boardSprite,board,10, 180, 83, tile_size);
        createRouteTile(boardSprite,board,11, 254, 83, tile_size);
        createRouteTile(boardSprite,board,12, 330, 83, tile_size);
        createRouteTile(boardSprite,board,13, 405, 83, tile_size);
        createRouteTile(boardSprite,board,14, 485, 83, tile_size);
        createRouteTile(boardSprite,board,15, 560, 83, tile_size);
        createRouteTile(boardSprite,board,16, 560, 5, tile_size);
        createRouteTile(boardSprite,board,17, 485, 5, tile_size);
        createRouteTile(boardSprite,board,18, 560, 159, tile_size);
        createRouteTile(boardSprite,board,19, 485, 159, tile_size);

        board[3].isRosette = true;
        board[7].isRosette = true;
        board[11].isRosette = true;
        board[17].isRosette = true;
        board[19].isRosette = true;

        for (let tile of board) {
            tiles.push(tile);
        }
        
        switch ($('input[name="gameMode"]:checked').val()) {
            case "PvP":
                players[0] = new Player(0, 'Biały');
                $("#AutoRollPlayer1Div").show();
                players[1] = new Player(1, 'Czarny');
                $("#AutoRollPlayer2Div").show();
                break;
            case "PvC":
                if($('input[name="humanColor"]:checked').val()==='white'){
                    players[0] = new Player(0, 'Biały');
                    $("#AutoRollPlayer1Div").show();
                    players[1] = new ComputerPlayer(1, 'Czarny');
                }
                else{
                    players[0] = new ComputerPlayer(0, 'Biały');
                    players[1] = new Player(1, 'Czarny');
                    $("#AutoRollPlayer2Div").show();
                }
                break;
            case "CvC":
                players[0] = new ComputerPlayer(0, 'Biały');
                players[1] = new ComputerPlayer(1, 'Czarny');
                break;
            
        }

        
        players[0].BeginTile = new BeginTile(100, 0, 200, boardSprite.position.y);
        players[0].EndTile = new EndTile(500, 0, 200, boardSprite.position.y, players[0]);
        players[0].Route = [0, 1, 2, 3, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, endTile];
        tiles.push(players[0].BeginTile);
        tiles.push(players[0].EndTile);
        for (let i = 0; i < pawnNumber; i++) {
            let sprite = new PIXI.Sprite(white);
            app.stage.addChild(sprite);
            let pawn = new Pawn(players[0], sprite,board);
            pawn.tile = players[0].BeginTile;
            players[0].pawns.push(pawn);
            players[0].BeginTile.pawns.push(pawn);
            players[0].BeginTile.setPawnDestination(pawn);
            pawn.sprite.x = pawn.destinationX;
            pawn.sprite.y = pawn.destinationY;
        }

        players[1].BeginTile = new BeginTile(100, boardSprite.y + boardSprite.height, 200, boardSprite.y);
        players[1].EndTile = new EndTile(500, boardSprite.y + boardSprite.height, 200, boardSprite.y, players[1]);
        players[1].Route = [4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 18, 19, endTile];
        tiles.push(players[1].BeginTile);
        tiles.push(players[1].EndTile);
        for (let i = 0; i < pawnNumber; i++) {
            let sprite = new PIXI.Sprite(black);
            app.stage.addChild(sprite);
            let pawn = new Pawn(players[1], sprite,board);
            pawn.tile = players[1].BeginTile;
            players[1].pawns.push(pawn);
            players[1].BeginTile.pawns.push(pawn);
            players[1].BeginTile.setPawnDestination(pawn);
            pawn.sprite.x = pawn.destinationX;
            pawn.sprite.y = pawn.destinationY;
        }
        // for (let tile of tiles) {
        //     tile.draw();
        // }


        setCurrentPlayer(0);

        function onKeyDown(key) {
            if(key.keyCode === 32){
                dicesTile.onClick();
            }
        }

        document.addEventListener('keydown', onKeyDown);

    }

</script>

</body>
</html>